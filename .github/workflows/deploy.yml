name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to project directory
            cd spectra
            
            # Pull latest code
            echo "ğŸ“¦ Pulling latest code from GitHub..."
            git pull origin main
            
            # Check if frontend changed
            if git diff --name-only HEAD@{1} HEAD | grep -q "spectra-web/"; then
              echo "ğŸ”¨ Rebuilding frontend..."
              cd spectra-web
              npm install
              npm run build
              rm -rf ../dist
              cp -r dist ..
              cd ..
            else
              echo "â­ï¸  No frontend changes, skipping build"
            fi
            
            # Restart backend service
            echo "ğŸ”„ Restarting backend service..."
            sudo systemctl restart spectramovie
            
            # Wait for service to start
            sleep 3
            
            # Check service status
            if sudo systemctl is-active --quiet spectramovie; then
              echo "âœ… Deployment successful! Service is running."
            else
              echo "âŒ Deployment failed! Service is not running."
              sudo journalctl -u spectramovie -n 20 --no-pager
              exit 1
            fi
            
            echo "ğŸ‰ Deployment complete!"
